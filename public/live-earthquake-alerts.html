<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Earthquake Alerts</title>
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, Segoe UI, Arial, sans-serif;
        background: #0b1220;
        color: #eef5ff;
      }

      html,
      body {
        height: 100%;
      }

      .page {
        height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr auto;
        background:
          radial-gradient(circle at 70% 42%, rgba(34, 95, 210, 0.28), rgba(4, 10, 24, 0.95) 45%),
          linear-gradient(160deg, #0a1327 0%, #040814 100%);
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(110, 162, 255, 0.25);
        background: rgba(5, 15, 36, 0.65);
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 34px;
        font-weight: 800;
      }

      .title-icon {
        color: #4cc6ff;
        font-size: 28px;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #8ff7b7;
        font-weight: 700;
        background: rgba(14, 41, 97, 0.65);
        border: 1px solid rgba(102, 176, 255, 0.33);
        border-radius: 999px;
        padding: 6px 12px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #46ff87;
        box-shadow: 0 0 8px rgba(70, 255, 135, 0.9);
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn {
        border: 1px solid rgba(141, 193, 255, 0.3);
        background: linear-gradient(180deg, #194aa6, #10316f);
        color: #f5f9ff;
        border-radius: 8px;
        padding: 8px 14px;
        font-weight: 700;
        cursor: pointer;
      }

      .btn.back {
        background: linear-gradient(180deg, #64748b, #334155);
      }

      .btn.primary {
        background: linear-gradient(180deg, #2b9cff, #1b6cdd);
      }

      .btn.success {
        background: linear-gradient(180deg, #22c55e, #15803d);
      }

      .email-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 140;
        background: rgba(2, 8, 20, 0.65);
        backdrop-filter: blur(2px);
      }

      .email-modal.open {
        display: flex;
      }

      .email-modal-card {
        width: min(560px, calc(100vw - 24px));
        max-height: calc(100vh - 28px);
        overflow: auto;
        border: 1px solid rgba(119, 174, 255, 0.4);
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(9, 23, 56, 0.98), rgba(4, 12, 34, 0.98));
        padding: 14px;
      }

      .email-modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 8px;
      }

      .email-modal-head h3 {
        margin: 0;
      }

      .email-help {
        margin: 0 0 10px;
        color: #b7cdef;
        font-size: 13px;
      }

      .email-add-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
      }

      .email-input {
        border: 1px solid rgba(141, 193, 255, 0.3);
        border-radius: 8px;
        padding: 9px 10px;
        color: #eef5ff;
        background: rgba(7, 19, 43, 0.9);
      }

      .email-status {
        min-height: 18px;
        font-size: 12px;
        color: #9bd2ff;
        margin: 8px 0;
      }

      .email-status.error {
        color: #ff9aa8;
      }

      .email-sub-list {
        margin-top: 8px;
        max-height: 220px;
        overflow: auto;
        border: 1px solid rgba(121, 170, 247, 0.24);
        border-radius: 9px;
        padding: 8px;
        background: rgba(5, 16, 37, 0.92);
      }

      .email-sub-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(124, 173, 255, 0.18);
        border-radius: 8px;
        padding: 7px 8px;
        margin-bottom: 6px;
      }

      .email-sub-item:last-child {
        margin-bottom: 0;
      }

      .email-tag {
        font-size: 11px;
        color: #9bbde5;
      }

      .layout {
        display: grid;
        grid-template-columns: 370px 1fr;
        gap: 14px;
        padding: 14px;
        min-height: 0;
      }

      .card {
        border: 1px solid rgba(106, 165, 255, 0.35);
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(8, 21, 52, 0.92), rgba(4, 11, 29, 0.92));
      }

      .left {
        padding: 10px;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .left-tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin: 0 2px 10px;
      }

      .left-tab {
        border: 1px solid rgba(124, 173, 255, 0.35);
        background: rgba(10, 29, 67, 0.86);
        color: #dce9ff;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 700;
        padding: 7px 10px;
        cursor: pointer;
      }

      .left-tab.active {
        background: linear-gradient(180deg, #2b9cff, #1b6cdd);
        color: #f7fbff;
      }

      .left-panel {
        display: none;
        flex: 1;
        min-height: 0;
        flex-direction: column;
      }

      .left-panel.active {
        display: flex;
      }

      .left h2 {
        margin: 4px 2px 8px;
        font-size: 30px;
      }

      .left-head {
        display: flex;
        justify-content: space-between;
        color: #9cb5de;
        font-weight: 700;
        font-size: 15px;
        padding: 0 8px 8px;
      }

      .events {
        flex: 1;
        max-height: none;
        overflow-y: auto;
      }

      .locations-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 2px;
      }

      .country-row {
        border: 1px solid rgba(124, 173, 255, 0.2);
        border-radius: 10px;
        margin-bottom: 6px;
        background: rgba(6, 17, 41, 0.88);
        overflow: hidden;
      }

      .country-row.active-country {
        border-color: rgba(82, 209, 142, 0.56);
      }

      .country-head {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border: none;
        background: transparent;
        color: #eef5ff;
        padding: 9px 10px;
        cursor: pointer;
        text-align: left;
      }

      .country-name {
        font-weight: 700;
        font-size: 14px;
      }

      .country-count {
        min-width: 32px;
        text-align: center;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: 800;
        color: #06142d;
        background: #86c7ff;
      }

      .country-count.live {
        background: #4bff9c;
      }

      .country-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 240ms ease;
        border-top: 1px solid rgba(124, 173, 255, 0.2);
      }

      .country-row.expanded .country-details {
        max-height: 360px;
      }

      .state-block {
        padding: 8px 10px;
        border-top: 1px solid rgba(124, 173, 255, 0.12);
      }

      .state-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
        color: #c0d5f4;
        margin-bottom: 6px;
      }

      .state-name {
        font-weight: 700;
        color: #f1f7ff;
      }

      .state-events {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .state-event {
        width: 100%;
        border: 1px solid rgba(113, 167, 250, 0.28);
        border-radius: 8px;
        background: rgba(8, 23, 53, 0.92);
        color: #e6f0ff;
        font-size: 12px;
        padding: 6px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .state-event strong {
        font-size: 11px;
        color: #85bfff;
      }

      .state-empty {
        color: #9db5dd;
        font-size: 12px;
        padding: 8px 10px;
      }

      .event {
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        gap: 8px;
        border: 1px solid rgba(124, 173, 255, 0.25);
        border-radius: 10px;
        padding: 8px;
        margin-bottom: 6px;
        background: rgba(6, 17, 41, 0.92);
        cursor: pointer;
      }

      .event.selected {
        border-color: rgba(255, 89, 89, 0.8);
        box-shadow: 0 0 0 1px rgba(255, 89, 89, 0.25);
      }

      .event .meta {
        display: flex;
        gap: 10px;
      }

      .flag {
        font-size: 22px;
      }

      .country {
        font-weight: 700;
        font-size: 16px;
      }

      .place {
        color: #b0c4e3;
        font-size: 13px;
        max-width: 165px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mag {
        text-align: right;
        min-width: 92px;
      }

      .mag-badge {
        display: inline-block;
        border-radius: 8px;
        padding: 2px 10px;
        font-weight: 800;
      }

      .m-veryhigh { background: linear-gradient(180deg, #cf1f35, #8c0d1d); }
      .m-high { background: linear-gradient(180deg, #ef7f1f, #b3470e); }
      .m-medium { background: linear-gradient(180deg, #d4bc18, #9c8308); }
      .m-low { background: linear-gradient(180deg, #2f96ef, #1a69bf); }

      .time {
        font-size: 12px;
        color: #b4c7e7;
        margin-top: 3px;
      }

      .right {
        position: relative;
        min-height: 0;
        overflow: hidden;
      }

      .globe-wrap {
        height: 100%;
        min-height: 380px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        overflow: hidden;
      }

      .globe {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        background:
          radial-gradient(circle at 30% 25%, rgba(58, 145, 255, 0.3), rgba(2, 8, 23, 0.97) 52%),
          url('https://unpkg.com/three-globe/example/img/earth-night.jpg') center/cover no-repeat;
        box-shadow: 0 0 40px rgba(94, 140, 255, 0.25);
        position: relative;
        overflow: hidden;
      }

      .tools {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 7px;
      }

      .tool {
        width: 34px;
        height: 34px;
        border: 1px solid rgba(119, 174, 255, 0.45);
        border-radius: 7px;
        background: rgba(5, 23, 54, 0.9);
        color: #eff6ff;
        font-weight: 800;
        cursor: pointer;
      }

      .source-meta {
        color: #9db5dd;
        font-size: 12px;
        margin-top: 8px;
      }

      .mini {
        position: absolute;
        right: 20px;
        bottom: 20px;
        width: 134px;
        height: 82px;
        border-radius: 8px;
        border: 1px solid rgba(112, 176, 255, 0.42);
        background: linear-gradient(180deg, rgba(4, 15, 42, 0.75), rgba(3, 9, 27, 0.78)), url('https://unpkg.com/three-globe/example/img/earth-dark.jpg') center/cover no-repeat;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        color: #dde9ff;
        font-size: 11px;
        padding-bottom: 4px;
      }

      .footer {
        display: grid;
        grid-template-columns: 370px 1fr;
        gap: 14px;
        padding: 0 14px 14px;
      }

      .legend,
      .stats {
        padding: 10px;
      }

      .legend h3,
      .stats h3 {
        margin: 0 0 8px;
      }

      .legend-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        color: #c5dbff;
        font-size: 14px;
      }

      .dot-s { font-size: 20px; line-height: 1; }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(110px, 1fr));
        gap: 8px;
      }

      .stats-item {
        border: 1px solid rgba(117, 172, 255, 0.33);
        border-radius: 8px;
        background: rgba(8, 22, 52, 0.8);
        padding: 8px;
      }

      .stats-item small {
        color: #9db6dd;
        font-size: 12px;
      }

      .stats-item strong {
        display: block;
        margin-top: 2px;
        font-size: 24px;
      }

      @media (max-width: 1200px) {
        .page {
          height: auto;
          min-height: 100vh;
          grid-template-rows: auto auto auto;
        }

        .layout,
        .footer {
          grid-template-columns: 1fr;
        }

        .globe-wrap {
          height: 420px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div class="title"><span class="title-icon">ðŸ“¡</span> Earthquake Live Monitor</div>
        <div class="status"><span class="dot"></span> Live Data <small id="updatedAt">Last Updated: Just Now</small></div>
        <div class="actions">
          <button class="btn back" id="backBtn" type="button">Back</button>
          <button class="btn success" id="emailAlertsBtn" type="button">Upload Emails</button>
          <button class="btn" id="autoRotateBtn" type="button">Stop Motion</button>
          <button class="btn" id="fullscreenBtn" type="button">Fullscreen</button>
          <button class="btn primary" id="refreshBtn" type="button">Refresh</button>
        </div>
      </div>

      <div class="layout">
        <aside class="left card">
          <h2>Recent Activity</h2>
          <div class="left-tabs">
            <button type="button" class="left-tab active" id="tabRecentBtn">Recent Activity</button>
            <button type="button" class="left-tab" id="tabLocationsBtn">Locations</button>
          </div>
          <div class="left-panel active" id="recentPanel">
            <div class="left-head"><span>Country</span><span>Magnitude</span></div>
            <div class="events" id="events"></div>
          </div>
          <div class="left-panel" id="locationsPanel">
            <div class="left-head"><span>Country</span><span>Live</span></div>
            <div class="locations-list" id="locationsList"></div>
          </div>
          <div id="sourceMeta" class="source-meta">Source: loadingâ€¦</div>
        </aside>

        <section class="right card">
          <div class="globe-wrap">
            <div id="globeViz" class="globe"></div>
          </div>
          <div class="tools">
            <button class="tool" id="zoomInBtn">+</button>
            <button class="tool" id="zoomOutBtn">âˆ’</button>
            <button class="tool" id="resetViewBtn">âŠ—</button>
          </div>
          <div class="mini">World View</div>
        </section>
      </div>

      <div class="footer">
        <section class="legend card">
          <h3>Magnitude Scale</h3>
          <div class="legend-row">
            <span class="dot-s" style="color:#49aefe">â€¢</span><span>M &lt; 4.0</span>
            <span class="dot-s" style="color:#e7d73b">â€¢</span><span>4.0 - 5.0</span>
            <span class="dot-s" style="color:#ff972a">â€¢</span><span>5.0 - 6.0</span>
            <span class="dot-s" style="color:#ff3553">â€¢</span><span>&gt; 6.0</span>
          </div>
        </section>

        <section class="stats card">
          <h3>Global Statistics (24h)</h3>
          <div class="stats-grid" id="statsGrid"></div>
        </section>
      </div>

      <div class="email-modal" id="emailModal">
        <div class="email-modal-card" role="dialog" aria-modal="true" aria-labelledby="emailModalTitle">
          <div class="email-modal-head">
            <h3 id="emailModalTitle">Earthquake Email Alerts (M &gt; 5)</h3>
            <button class="btn back" id="emailModalCloseBtn" type="button">Close</button>
          </div>
          <p class="email-help">Enter Gmail addresses to receive live notifications for earthquakes above magnitude 5. This subscription is shared across devices.</p>
          <div class="email-add-row">
            <input id="emailInput" class="email-input" type="email" placeholder="example@gmail.com" autocomplete="email" />
            <button class="btn success" id="emailAddBtn" type="button">Add Gmail</button>
          </div>
          <div id="emailStatus" class="email-status"></div>
          <div id="emailThresholdTag" class="email-tag">Threshold: M 5.0+</div>
          <div class="email-sub-list" id="emailSubscribersList"></div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script>
      const EARTH3D_SCENE_ID = 'b9f8d30d65cd487d8302b6b55aa094c7';
      const USGS_FEEDS = [
        'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson',
        'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson'
      ];
      const ALL_ORIGINS = 'https://api.allorigins.win/raw?url=';
      const EARTHQUAKE_ALERT_PATH = '/api/earthquake-alerts';

      function stripTrailingSlash(value) {
        return String(value || '').replace(/\/+$/, '');
      }

      function buildApiTargets(path) {
        const targets = new Set([path]);
        const host = window.location.hostname;
        const isLocalhost = host === 'localhost' || host === '127.0.0.1';

        if (isLocalhost) {
          targets.add(`http://localhost:8787${path}`);
        } else {
          targets.add(`https://resilience360-backend.onrender.com${path}`);
        }

        return Array.from(targets).map((item) => {
          if (/^https?:\/\//i.test(item)) return item;
          return stripTrailingSlash(item);
        });
      }

      async function requestJsonWithFallback(path, options = {}) {
        const targets = buildApiTargets(path);
        let lastError = null;

        for (const target of targets) {
          try {
            const response = await fetch(target, options);
            const payload = await response.json().catch(() => null);
            if (!response.ok) {
              lastError = new Error(String(payload?.error || `Request failed (${response.status})`));
              continue;
            }
            return payload;
          } catch (error) {
            lastError = error;
          }
        }

        throw lastError || new Error('Network request failed.');
      }

      let globe = null;
      let quakeRows = [];
      let selectedId = null;
      let currentAltitude = 1.7;
      let eventsData = [];
      let locationsData = [];
      let activeLeftTab = 'recent';
      let expandedCountry = null;
      let emailSubscribers = [];
      let isEmailModalOpen = false;
      let earthquakeAlertThreshold = 5;
      const defaultCenter = { lat: 20, lng: 15 };
      let isAutoRotateEnabled = true;

      const usStateNames = new Set([
        'alabama','alaska','arizona','arkansas','california','colorado','connecticut','delaware','florida','georgia','hawaii','idaho','illinois','indiana','iowa','kansas','kentucky','louisiana','maine','maryland','massachusetts','michigan','minnesota','mississippi','missouri','montana','nebraska','nevada','new hampshire','new jersey','new mexico','new york','north carolina','north dakota','ohio','oklahoma','oregon','pennsylvania','rhode island','south carolina','south dakota','tennessee','texas','utah','vermont','virginia','washington','west virginia','wisconsin','wyoming','district of columbia'
      ]);
      const usStateAbbr = new Set(['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC']);
      const caProvinceNames = new Set(['alberta','british columbia','manitoba','new brunswick','newfoundland and labrador','northwest territories','nova scotia','nunavut','ontario','prince edward island','quebec','saskatchewan','yukon']);
      const caProvinceAbbr = new Set(['AB','BC','MB','NB','NL','NT','NS','NU','ON','PE','QC','SK','YT']);
      const countryAlias = {
        usa: 'United States',
        'u.s.a.': 'United States',
        'u.s.': 'United States',
        us: 'United States',
        uk: 'United Kingdom',
        uae: 'United Arab Emirates',
        russia: 'Russia',
        korea: 'South Korea',
        'south korea': 'South Korea',
        'north korea': 'North Korea',
      };

      const regionDisplay = typeof Intl !== 'undefined' && Intl.DisplayNames
        ? new Intl.DisplayNames(['en'], { type: 'region' })
        : null;

      function getAllCountries() {
        if (!regionDisplay || !Intl.supportedValuesOf) return [];
        try {
          return Intl.supportedValuesOf('region')
            .map((code) => regionDisplay.of(code))
            .filter((name) => Boolean(name) && typeof name === 'string' && !/^\d+$/.test(name))
            .sort((a, b) => a.localeCompare(b));
        } catch {
          return [];
        }
      }

      const allCountries = getAllCountries();

      function selectedQuakeRings(selected) {
        if (!selected) return [];

        return [
          {
            id: `${selected.id}-ring-a`,
            lat: selected.lat,
            lng: selected.lng,
            color: '#ff2a45',
            maxRadius: 5.2,
            speed: 1.5,
            period: 1800,
          },
          {
            id: `${selected.id}-ring-b`,
            lat: selected.lat,
            lng: selected.lng,
            color: '#ff5f52',
            maxRadius: 4.2,
            speed: 1.25,
            period: 1350,
          },
          {
            id: `${selected.id}-ring-c`,
            lat: selected.lat,
            lng: selected.lng,
            color: '#ff9a6a',
            maxRadius: 3.4,
            speed: 1.05,
            period: 980,
          },
        ];
      }

      function resizeGlobeViewport() {
        if (!globe) return;
        const host = document.getElementById('globeViz');
        if (!host) return;
        const width = Math.max(320, Math.floor(host.clientWidth));
        const height = Math.max(280, Math.floor(host.clientHeight));
        globe.width(width).height(height);
      }

      function tierClass(m) {
        if (m >= 6) return 'm-veryhigh';
        if (m >= 5) return 'm-high';
        if (m >= 4) return 'm-medium';
        return 'm-low';
      }

      function normalizeCountryToken(token) {
        const raw = String(token || '').trim();
        if (!raw) return 'Unknown';

        const lowered = raw.toLowerCase();
        if (countryAlias[lowered]) return countryAlias[lowered];

        if (/^[A-Z]{2}$/.test(raw) && regionDisplay) {
          const display = regionDisplay.of(raw);
          if (display && display !== raw) return display;
        }

        return raw;
      }

      function parseGeoFromPlace(place) {
        const raw = String(place || '').trim();
        const parts = raw.split(',').map((segment) => segment.trim()).filter(Boolean);
        const last = parts[parts.length - 1] || 'Unknown';
        const prev = parts.length > 1 ? parts[parts.length - 2] : '';

        const lastUpper = last.toUpperCase();
        const lastLower = last.toLowerCase();
        const prevUpper = prev.toUpperCase();
        const prevLower = prev.toLowerCase();

        if (usStateAbbr.has(lastUpper) || usStateNames.has(lastLower)) {
          return { country: 'United States', subdivision: last };
        }

        if (caProvinceAbbr.has(lastUpper) || caProvinceNames.has(lastLower)) {
          return { country: 'Canada', subdivision: last };
        }

        if (usStateAbbr.has(prevUpper) || usStateNames.has(prevLower)) {
          return { country: 'United States', subdivision: prev };
        }

        if (caProvinceAbbr.has(prevUpper) || caProvinceNames.has(prevLower)) {
          return { country: 'Canada', subdivision: prev };
        }

        return { country: normalizeCountryToken(last), subdivision: null };
      }

      function countryFromPlace(place) {
        return parseGeoFromPlace(place).country;
      }

      function flagFor(country) {
        const x = country.toLowerCase();
        if (x.includes('usa') || x.includes('united states')) return 'ðŸ‡ºðŸ‡¸';
        if (x.includes('mexico')) return 'ðŸ‡²ðŸ‡½';
        if (x.includes('japan')) return 'ðŸ‡¯ðŸ‡µ';
        if (x.includes('indonesia')) return 'ðŸ‡®ðŸ‡©';
        if (x.includes('pakistan')) return 'ðŸ‡µðŸ‡°';
        return 'ðŸŒ';
      }

      function toPointColor(m) {
        if (m >= 6.5) return '#ff3656';
        if (m >= 5.5) return '#ff982c';
        if (m >= 4.5) return '#e7d63a';
        return '#4aaefe';
      }

      function setLeftTab(tab) {
        activeLeftTab = tab === 'locations' ? 'locations' : 'recent';

        const recentBtn = document.getElementById('tabRecentBtn');
        const locationsBtn = document.getElementById('tabLocationsBtn');
        const recentPanel = document.getElementById('recentPanel');
        const locationsPanel = document.getElementById('locationsPanel');

        if (!recentBtn || !locationsBtn || !recentPanel || !locationsPanel) return;

        const isRecent = activeLeftTab === 'recent';
        recentBtn.classList.toggle('active', isRecent);
        locationsBtn.classList.toggle('active', !isRecent);
        recentPanel.classList.toggle('active', isRecent);
        locationsPanel.classList.toggle('active', !isRecent);
      }

      function buildLocationsData(data) {
        const map = new Map();

        for (const name of allCountries) {
          map.set(name, {
            country: name,
            total: 0,
            subdivisions: new Map(),
          });
        }

        for (const event of data) {
          const geo = parseGeoFromPlace(event.properties.place);
          const eventId = String(event.id ?? `${event.geometry.coordinates?.[1]}-${event.geometry.coordinates?.[0]}-${event.properties.time}`);

          if (!map.has(geo.country)) {
            map.set(geo.country, {
              country: geo.country,
              total: 0,
              subdivisions: new Map(),
            });
          }

          const countryEntry = map.get(geo.country);
          countryEntry.total += 1;

          const subdivisionKey = geo.subdivision || 'Other Areas';
          if (!countryEntry.subdivisions.has(subdivisionKey)) {
            countryEntry.subdivisions.set(subdivisionKey, {
              name: subdivisionKey,
              events: [],
            });
          }

          countryEntry.subdivisions.get(subdivisionKey).events.push({
            id: eventId,
            place: String(event.properties.place || 'Unknown'),
            mag: Number(event.properties.mag || 0),
            time: Number(event.properties.time || Date.now()),
          });
        }

        const rows = Array.from(map.values()).map((entry) => {
          const subdivisions = Array.from(entry.subdivisions.values())
            .map((item) => ({
              name: item.name,
              events: item.events.sort((a, b) => b.mag - a.mag),
            }))
            .sort((a, b) => b.events.length - a.events.length || a.name.localeCompare(b.name));

          return {
            country: entry.country,
            total: entry.total,
            subdivisions,
          };
        });

        rows.sort((a, b) => {
          if (a.total > 0 && b.total > 0) return b.total - a.total || a.country.localeCompare(b.country);
          if (a.total > 0) return -1;
          if (b.total > 0) return 1;
          return a.country.localeCompare(b.country);
        });

        return rows;
      }

      function renderLocationsPanel() {
        const host = document.getElementById('locationsList');
        if (!host) return;

        host.innerHTML = locationsData.map((countryRow) => {
          const isExpanded = expandedCountry === countryRow.country;
          const rowClass = `country-row ${countryRow.total > 0 ? 'active-country' : ''} ${isExpanded ? 'expanded' : ''}`;
          const countClass = `country-count ${countryRow.total > 0 ? 'live' : ''}`;

          const details = countryRow.total > 0
            ? countryRow.subdivisions.map((sub) => {
                const events = sub.events.map((ev) => `
                  <button class="state-event" data-event-id="${ev.id}">
                    <span>${ev.place}</span>
                    <strong>M ${ev.mag.toFixed(1)}</strong>
                  </button>
                `).join('');

                return `
                  <div class="state-block">
                    <div class="state-head">
                      <span class="state-name">${sub.name}</span>
                      <span>${sub.events.length} live</span>
                    </div>
                    <div class="state-events">${events}</div>
                  </div>
                `;
              }).join('')
            : '<div class="state-empty">No active earthquakes</div>';

          return `
            <div class="${rowClass}">
              <button type="button" class="country-head" data-country="${countryRow.country}">
                <span class="country-name">${countryRow.country}</span>
                <span class="${countClass}">${countryRow.total}</span>
              </button>
              <div class="country-details">${details}</div>
            </div>
          `;
        }).join('');

        host.querySelectorAll('.country-head').forEach((button) => {
          button.addEventListener('click', () => {
            const country = button.getAttribute('data-country');
            expandedCountry = expandedCountry === country ? null : country;
            renderLocationsPanel();
          });
        });

        host.querySelectorAll('.state-event').forEach((button) => {
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            const eventId = button.getAttribute('data-event-id');
            if (eventId) selectEvent(eventId);
            setLeftTab('recent');
          });
        });
      }

      function setEmailStatus(message, isError = false) {
        const statusEl = document.getElementById('emailStatus');
        if (!statusEl) return;
        statusEl.textContent = message || '';
        statusEl.classList.toggle('error', Boolean(isError));
      }

      function renderSubscribersList() {
        const host = document.getElementById('emailSubscribersList');
        const thresholdTag = document.getElementById('emailThresholdTag');
        if (!host) return;

        if (thresholdTag) {
          thresholdTag.textContent = `Threshold: M ${Number(earthquakeAlertThreshold || 5).toFixed(1)}+`;
        }

        if (!emailSubscribers.length) {
          host.innerHTML = '<div class="state-empty">No Gmail subscribers added yet.</div>';
          return;
        }

        host.innerHTML = emailSubscribers.map((subscriber) => `
          <div class="email-sub-item">
            <div>
              <div>${subscriber.email}</div>
              <div class="email-tag">Subscribed ${new Date(subscriber.subscribedAt || Date.now()).toLocaleString()}</div>
            </div>
            <button class="btn back" type="button" data-remove-email="${subscriber.email}">Remove</button>
          </div>
        `).join('');

        host.querySelectorAll('[data-remove-email]').forEach((button) => {
          button.addEventListener('click', async () => {
            const email = button.getAttribute('data-remove-email');
            if (!email) return;

            try {
              await requestJsonWithFallback(`${EARTHQUAKE_ALERT_PATH}/subscriptions/remove`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email }),
              });
              setEmailStatus(`Removed ${email}`);
              await loadSubscribers();
            } catch (error) {
              setEmailStatus(error?.message || 'Failed to remove subscriber.', true);
            }
          });
        });
      }

      function openEmailModal() {
        const modal = document.getElementById('emailModal');
        if (!modal) return;
        modal.classList.add('open');
        isEmailModalOpen = true;
      }

      function closeEmailModal() {
        const modal = document.getElementById('emailModal');
        if (!modal) return;
        modal.classList.remove('open');
        isEmailModalOpen = false;
      }

      async function loadSubscribers() {
        try {
          const payload = await requestJsonWithFallback(`${EARTHQUAKE_ALERT_PATH}/subscriptions`, { method: 'GET' });
          emailSubscribers = Array.isArray(payload?.subscribers) ? payload.subscribers : [];
          earthquakeAlertThreshold = Number(payload?.threshold ?? 5) || 5;
          renderSubscribersList();
        } catch (error) {
          setEmailStatus(error?.message || 'Unable to load subscribers.', true);
        }
      }

      async function addSubscriberFromInput() {
        const input = document.getElementById('emailInput');
        if (!input) return;

        const email = String(input.value || '').trim().toLowerCase();
        if (!email) {
          setEmailStatus('Please enter a Gmail address.', true);
          return;
        }

        try {
          await requestJsonWithFallback(`${EARTHQUAKE_ALERT_PATH}/subscriptions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
          });
          input.value = '';
          setEmailStatus(`Subscribed ${email} for live M > ${earthquakeAlertThreshold} alerts.`);
          await loadSubscribers();
        } catch (error) {
          setEmailStatus(error?.message || 'Failed to subscribe Gmail.', true);
        }
      }

      async function triggerAlertDispatch() {
        try {
          await requestJsonWithFallback(`${EARTHQUAKE_ALERT_PATH}/dispatch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trigger: 'live-monitor' }),
          });
        } catch {
        }
      }

      async function fetchEarth3DArcGisSource() {
        const itemDataUrl = `https://www.arcgis.com/sharing/rest/content/items/${EARTH3D_SCENE_ID}/data?f=json`;
        const itemDataRes = await fetch(itemDataUrl, { cache: 'no-store' });
        if (!itemDataRes.ok) throw new Error('ArcGIS scene metadata unavailable');
        const itemData = await itemDataRes.json();
        const layers = itemData?.operationalLayers || [];
        const candidateLayer = layers.find((layer) => {
          const label = `${layer?.title || ''} ${layer?.url || ''}`.toLowerCase();
          return label.includes('quake') || label.includes('earthquake') || label.includes('usgs');
        }) || layers.find((layer) => String(layer?.url || '').includes('FeatureServer'));

        const baseUrl = candidateLayer?.url;
        if (!baseUrl || !baseUrl.includes('FeatureServer')) throw new Error('No ArcGIS earthquake layer found');

        const queryUrl = `${baseUrl}/query?where=1%3D1&outFields=*&f=json&returnGeometry=true&orderByFields=time%20DESC&resultRecordCount=200`;
        const queryRes = await fetch(queryUrl, { cache: 'no-store' });
        if (!queryRes.ok) throw new Error('ArcGIS earthquake query failed');
        const queryJson = await queryRes.json();
        const features = Array.isArray(queryJson?.features) ? queryJson.features : [];

        const normalized = features
          .map((item) => {
            const attr = item?.attributes || {};
            const geom = item?.geometry || {};
            const mag = Number(attr.mag ?? attr.magnitude ?? attr.Magnitude ?? 0);
            const lat = Number(geom.y ?? attr.latitude ?? attr.lat);
            const lng = Number(geom.x ?? attr.longitude ?? attr.lon ?? attr.lng);
            const time = Number(attr.time ?? attr.updated ?? Date.now());
            const place = String(attr.place ?? attr.title ?? attr.location ?? 'Unknown location');
            if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
            return {
              id: String(attr.id ?? attr.objectid ?? attr.OBJECTID ?? `${lat}-${lng}-${time}`),
              properties: {
                mag: Number.isFinite(mag) ? mag : 0,
                place,
                time,
                url: String(attr.url ?? attr.link ?? 'https://earth3dmap.com/earthquake-live-map/')
              },
              geometry: {
                coordinates: [lng, lat, Number(attr.depth ?? attr.depth_km ?? 0)]
              }
            };
          })
          .filter(Boolean);

        if (!normalized.length) throw new Error('ArcGIS returned no usable points');
        return { features: normalized, sourceLabel: 'Source: Earth3DMap (ArcGIS live layer)' };
      }

      async function fetchUsgsFallback() {
        for (const feed of USGS_FEEDS) {
          try {
            const res = await fetch(feed, { cache: 'no-store' });
            if (!res.ok) continue;
            const json = await res.json();
            const features = Array.isArray(json.features) ? json.features : [];
            if (features.length) {
              return { features, sourceLabel: 'Source: Earth3DMap route + USGS live feed' };
            }
          } catch {}
        }
        throw new Error('USGS fallback unavailable');
      }

      async function fetchLiveEarthquakes() {
        try {
          return await fetchEarth3DArcGisSource();
        } catch {
          try {
            const proxiedScene = await fetch(`${ALL_ORIGINS}${encodeURIComponent('https://earth3dmap.com/earthquake-live-map/')}`, { cache: 'no-store' });
            if (proxiedScene.ok) {
              return await fetchUsgsFallback();
            }
          } catch {}
          return await fetchUsgsFallback();
        }
      }

      function ensureGlobe() {
        if (globe) return globe;
        const el = document.getElementById('globeViz');
        globe = Globe()(el)
          .width(Math.max(320, Math.floor(el.clientWidth)))
          .height(Math.max(280, Math.floor(el.clientHeight)))
          .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
          .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
          .backgroundColor('rgba(0,0,0,0)')
          .showAtmosphere(true)
          .atmosphereColor('#5ca8ff')
          .atmosphereAltitude(0.18)
          .pointLabel((d) => d.label)
          .onPointClick((d) => selectEvent(d.id));

        const controls = globe.controls();
        controls.autoRotate = isAutoRotateEnabled;
        controls.autoRotateSpeed = 0.35;
        controls.enableDamping = true;
        controls.dampingFactor = 0.06;

        window.addEventListener('resize', resizeGlobeViewport);
        window.setTimeout(resizeGlobeViewport, 30);
        return globe;
      }

      function refreshPointsAppearance() {
        if (!globe) return;

        const selected = eventsData.find((item) => item.id === selectedId) || null;

        globe
          .pointAltitude((d) => {
            const base = Math.max(0.01, Math.min(0.22, 0.02 + d.mag * 0.02));
            if (d.id === selectedId) {
              return Math.min(0.38, base + 0.1);
            }
            return base;
          })
          .pointRadius((d) => {
            const base = Math.max(0.08, Math.min(0.28, 0.08 + d.mag * 0.03));
            if (d.id === selectedId) {
              return Math.min(0.46, base + 0.12);
            }
            return base;
          })
          .pointColor((d) => {
            if (d.id === selectedId) {
              return '#ff1f3d';
            }
            return toPointColor(d.mag);
          })
          .ringsData(selectedQuakeRings(selected))
          .ringLat('lat')
          .ringLng('lng')
          .ringColor((d) => (t) => {
            const alpha = Math.max(0, 0.95 - t);
            const tone = d.color || '#ff3856';
            const r = parseInt(tone.slice(1, 3), 16);
            const g = parseInt(tone.slice(3, 5), 16);
            const b = parseInt(tone.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha.toFixed(3)})`;
          })
          .ringMaxRadius('maxRadius')
          .ringPropagationSpeed('speed')
          .ringRepeatPeriod('period');
      }

      function setAutoRotation(enabled) {
        isAutoRotateEnabled = Boolean(enabled);
        const glb = ensureGlobe();
        const controls = glb.controls();
        controls.autoRotate = isAutoRotateEnabled;

        const autoRotateBtn = document.getElementById('autoRotateBtn');
        if (autoRotateBtn) {
          autoRotateBtn.textContent = isAutoRotateEnabled ? 'Stop Motion' : 'Start Motion';
        }
      }

      function focusOn(id) {
        if (!globe || !eventsData.length) return;
        const selected = eventsData.find((item) => item.id === id);
        const target = selected || eventsData[0];
        if (!target) return;
        globe.pointOfView({ lat: target.lat, lng: target.lng, altitude: selected ? 0.55 : 1.7 }, 1000);
      }

      function selectEvent(id) {
        selectedId = id;
        for (const row of quakeRows) {
          row.classList.toggle('selected', row.dataset.id === id);
        }
        refreshPointsAppearance();
        focusOn(id);
      }

      function render(data) {
        const eventsEl = document.getElementById('events');
        const statsGrid = document.getElementById('statsGrid');
        const updatedAt = document.getElementById('updatedAt');
        const sourceMeta = document.getElementById('sourceMeta');
        const glb = ensureGlobe();

        const items = data.slice(0, 8);
        const globeItems = data.slice(0, 240);
        eventsEl.innerHTML = items.map((e) => {
          const country = countryFromPlace(e.properties.place);
          const mag = Number(e.properties.mag || 0);
          const t = new Date(e.properties.time);
          const id = String(e.id ?? `${e.geometry.coordinates[1]}-${e.geometry.coordinates[0]}-${e.properties.time}`);
          return `
            <button class="event" data-id="${id}">
              <div class="meta">
                <div class="flag">${flagFor(country)}</div>
                <div>
                  <div class="country">${country}</div>
                  <div class="place">${e.properties.place || ''}</div>
                </div>
              </div>
              <div class="mag">
                <span class="mag-badge ${tierClass(mag)}">M ${mag.toFixed(1)}</span>
                <div class="time">${t.toLocaleTimeString()}</div>
              </div>
            </button>
          `;
        }).join('');

        quakeRows = Array.from(eventsEl.querySelectorAll('.event'));
        quakeRows.forEach((row) => row.addEventListener('click', () => selectEvent(row.dataset.id)));

        eventsData = globeItems.map((e) => {
          const mag = Number(e.properties.mag || 0);
          const lat = Number(e.geometry.coordinates?.[1]);
          const lng = Number(e.geometry.coordinates?.[0]);
          return {
            id: String(e.id ?? `${lat}-${lng}-${e.properties.time}`),
            mag,
            lat,
            lng,
            label: `<strong>M ${mag.toFixed(1)}</strong><br/>${e.properties.place || 'Unknown'}<br/>${new Date(e.properties.time).toLocaleString()}`,
          };
        }).filter((x) => Number.isFinite(x.lat) && Number.isFinite(x.lng));

        locationsData = buildLocationsData(data);
        renderLocationsPanel();

        glb
          .pointsData(eventsData)
          .pointLat('lat')
          .pointLng('lng')
          .pointAltitude((d) => Math.max(0.01, Math.min(0.22, 0.02 + d.mag * 0.02)))
          .pointRadius((d) => Math.max(0.08, Math.min(0.28, 0.08 + d.mag * 0.03)))
          .pointColor((d) => d.id === selectedId ? '#ff3553' : toPointColor(d.mag));

        refreshPointsAppearance();

        if (sourceMeta) {
          sourceMeta.textContent = window.__sourceLabel || 'Source: live feed';
        }

        const mags = data.map((x) => Number(x.properties.mag || 0));
        const avg = mags.length ? mags.reduce((a, b) => a + b, 0) / mags.length : 0;
        const max = mags.length ? Math.max(...mags) : 0;
        const countries = locationsData.filter((row) => row.total > 0).length;

        statsGrid.innerHTML = `
          <div class="stats-item"><small>Total Events</small><strong>${data.length}</strong></div>
          <div class="stats-item"><small>Avg. Magnitude</small><strong>${avg.toFixed(1)}</strong></div>
          <div class="stats-item"><small>Largest</small><strong>M ${max.toFixed(1)}</strong></div>
          <div class="stats-item"><small>Locations</small><strong>${countries} Countries</strong></div>
        `;

        updatedAt.textContent = `Last Updated: ${new Date().toLocaleTimeString()}`;

        if (items.length) {
          const firstId = String(items[0].id ?? `${items[0].geometry.coordinates[1]}-${items[0].geometry.coordinates[0]}-${items[0].properties.time}`);
          selectEvent(selectedId || firstId);
        }
      }

      async function load() {
        try {
          const { features, sourceLabel } = await fetchLiveEarthquakes();
          window.__sourceLabel = sourceLabel;
          render(features);
          await triggerAlertDispatch();
        } catch {
          window.__sourceLabel = 'Source: unavailable';
          render([]);
        }
      }

      function bindControls() {
        const backBtn = document.getElementById('backBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const autoRotateBtn = document.getElementById('autoRotateBtn');
        const emailAlertsBtn = document.getElementById('emailAlertsBtn');
        const emailModal = document.getElementById('emailModal');
        const emailModalCloseBtn = document.getElementById('emailModalCloseBtn');
        const emailAddBtn = document.getElementById('emailAddBtn');
        const emailInput = document.getElementById('emailInput');
        const tabRecentBtn = document.getElementById('tabRecentBtn');
        const tabLocationsBtn = document.getElementById('tabLocationsBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        backBtn.addEventListener('click', () => {
          if (window.history.length > 1) {
            window.history.back();
            return;
          }
          window.location.href = './';
        });

        refreshBtn.addEventListener('click', () => {
          load();
        });

        autoRotateBtn.addEventListener('click', () => {
          setAutoRotation(!isAutoRotateEnabled);
        });

        emailAlertsBtn.addEventListener('click', async () => {
          openEmailModal();
          await loadSubscribers();
        });

        emailModalCloseBtn.addEventListener('click', () => {
          closeEmailModal();
        });

        emailAddBtn.addEventListener('click', async () => {
          await addSubscriberFromInput();
        });

        emailInput.addEventListener('keydown', async (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            await addSubscriberFromInput();
          }
        });

        emailModal.addEventListener('click', (event) => {
          if (event.target === emailModal) {
            closeEmailModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isEmailModalOpen) {
            closeEmailModal();
          }
        });

        tabRecentBtn.addEventListener('click', () => setLeftTab('recent'));
        tabLocationsBtn.addEventListener('click', () => setLeftTab('locations'));

        fullscreenBtn.addEventListener('click', async () => {
          if (document.fullscreenElement) {
            await document.exitFullscreen();
          } else {
            await document.documentElement.requestFullscreen();
          }
        });

        zoomInBtn.addEventListener('click', () => {
          const glb = ensureGlobe();
          currentAltitude = Math.max(0.85, currentAltitude - 0.18);
          glb.pointOfView({ ...defaultCenter, altitude: currentAltitude }, 320);
        });

        zoomOutBtn.addEventListener('click', () => {
          const glb = ensureGlobe();
          currentAltitude = Math.min(2.8, currentAltitude + 0.18);
          glb.pointOfView({ ...defaultCenter, altitude: currentAltitude }, 320);
        });

        resetViewBtn.addEventListener('click', () => {
          const glb = ensureGlobe();
          currentAltitude = 1.7;
          selectedId = null;
          glb.pointOfView({ ...defaultCenter, altitude: currentAltitude }, 600);
          for (const row of quakeRows) row.classList.remove('selected');
          refreshPointsAppearance();
        });

        setAutoRotation(true);
        setLeftTab(activeLeftTab);
      }

      bindControls();
      loadSubscribers();
      load();
      window.setInterval(load, 120000);
    </script>
  </body>
</html>
